name: Discord Notifications
on:
  push:
    branches:
      - main
  pull_request:
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            TITLE="ðŸš€ Push to ${{ github.repository }}"

            COMMIT_LIST=""
            COUNT=0
            COMMITS_JSON='${{ toJson(github.event.commits) }}'
            TOTAL_COMMITS=$(echo "$COMMITS_JSON" | jq -r 'length')

            if [ "$TOTAL_COMMITS" = "null" ] || [ "$TOTAL_COMMITS" = "0" ]; then
              TOTAL_COMMITS=1
              COMMIT_LIST="$COMMIT_LIST"$'\n'"â€¢ Single commit push"
            else
              for commit in $(echo "$COMMITS_JSON" | jq -r '.[].id'); do
                if [ $COUNT -ge 10 ]; then
                  REMAINING=$((TOTAL_COMMITS - 10))
                  COMMIT_LIST="${COMMIT_LIST}"$'\n'"...and ${REMAINING} more commits"
                  break
                fi
                MESSAGE=$(echo "$COMMITS_JSON" | jq -r ".[$COUNT].message" | head -n 1)
                SHORT_SHA=$(echo "$commit" | cut -c1-7)
                URL=$(echo "$COMMITS_JSON" | jq -r ".[$COUNT].url")
                AUTHOR=$(echo "$COMMITS_JSON" | jq -r ".[$COUNT].author.name")
                # truncate commit message to 80 chars for readability
                MESSAGE_TRUNC=$(echo "$MESSAGE" | cut -c1-80)
                COMMIT_LIST="${COMMIT_LIST}"$'\n'"â€¢ [\`${SHORT_SHA}\`](${URL}) ${MESSAGE_TRUNC} - *${AUTHOR}*"
                COUNT=$((COUNT+1))
              done
            fi

            # Use $'\n' for real line breaks in Discord
            DESCRIPTION="**Branch:** \`${{ github.ref_name }}\`"$'\n'
            DESCRIPTION="${DESCRIPTION}**Pushed by:** ${{ github.actor }}"$'\n'
            DESCRIPTION="${DESCRIPTION}**Commits:** ${TOTAL_COMMITS}"$'\n'
            DESCRIPTION="${DESCRIPTION}${COMMIT_LIST}"$'\n\n'
            DESCRIPTION="${DESCRIPTION}[View comparison](${{ github.event.compare }})"

            COLOR=3066993

          else
            TITLE="ðŸ”€ Pull Request #${{ github.event.pull_request.number }}"
            DESCRIPTION="**Repository:** ${{ github.repository }}"$'\n'
            DESCRIPTION="${DESCRIPTION}**Action:** ${{ github.event.action }}"$'\n'
            DESCRIPTION="${DESCRIPTION}**Author:** ${{ github.event.pull_request.user.login }}"$'\n'
            DESCRIPTION="${DESCRIPTION}**Title:** ${{ github.event.pull_request.title }}"$'\n'
            DESCRIPTION="${DESCRIPTION}**Branch:** \`${{ github.event.pull_request.head.ref }}\` â†’ \`${{ github.event.pull_request.base.ref }}\`"$'\n'
            DESCRIPTION="${DESCRIPTION}**Commits:** ${{ github.event.pull_request.commits }}"$'\n'
            DESCRIPTION="${DESCRIPTION}**Changed files:** ${{ github.event.pull_request.changed_files }}"$'\n'
            DESCRIPTION="${DESCRIPTION}**+${{ github.event.pull_request.additions }}/-${{ github.event.pull_request.deletions }}**"$'\n\n'
            DESCRIPTION="${DESCRIPTION}[View Pull Request](${{ github.event.pull_request.html_url }})"

            COLOR=15105570
          fi

          PAYLOAD=$(jq -n \
            --arg username "GitHub Bot" \
            --arg avatar "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg title "$TITLE" \
            --arg description "$DESCRIPTION" \
            --argjson color $COLOR \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            --arg footer_text "GitHub Actions" \
            --arg repo_url "${{ github.event.repository.html_url }}" \
            '{
              username: $username,
              avatar_url: $avatar,
              embeds: [{
                title: $title,
                description: $description,
                color: $color,
                timestamp: $timestamp,
                footer: {text: $footer_text},
                url: $repo_url
              }]
            }'
          )

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               ${{ secrets.DISCORD_WEBHOOK }}
